<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JHU Measles Map (Corrected)</title>
    <style>
        body { 
            background: #f4f4f9; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden;
        }
        
        #status {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 14px; color: #333;
            max-width: 300px; z-index: 100;
        }

        /* Error box styling */
        #error-box {
            display: none;
            position: absolute; bottom: 20px; left: 20px;
            background: #fff0f0; color: #d32f2f;
            border: 1px solid #ffcdd2; padding: 15px;
            border-radius: 6px; z-index: 999;
            font-family: monospace;
        }

        svg { width: 100vw; height: 100vh; display: block; }
        
        path { stroke: #fff; stroke-width: 0.5; transition: fill 0.2s; }
        .state { fill: #e0e0e0; cursor: pointer; }
        .state:hover { fill: #d0d0d0; }
        .county { stroke: #fff; stroke-width: 0.1; pointer-events: all; }
        
        .tooltip {
            position: absolute; background: rgba(0,0,0,0.85); color: #fff; 
            padding: 8px 12px; border-radius: 4px; pointer-events: none; 
            opacity: 0; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: translate(-50%, -100%); margin-top: -12px;
            white-space: nowrap; z-index: 1000;
        }
    </style>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>
<body>

<div id="status">
    <h3 style="margin:0 0 5px 0;">US Measles Tracker</h3>
    <div id="loading-msg">‚è≥ Connecting to JHU Data...</div>
    <div id="data-stats" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
</div>
<div id="error-box"></div>
<div class="tooltip"></div>

<script>
// --- CORRECTED CONFIGURATION ---
// Derived from your screenshot: Branch "main" and File "measles_county_all_updates.csv"
const JHU_URL = "https://raw.githubusercontent.com/CSSEGISandData/measles_data/main/measles_county_all_updates.csv";
const ATLAS_URL = "https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json";

// --- ERROR HANDLER ---
function reportError(msg) {
    const box = document.getElementById("error-box");
    box.style.display = "block";
    box.innerHTML += `üõë ${msg}<br>`;
    console.error(msg);
    document.getElementById("loading-msg").textContent = "‚ùå Error Loading Data";
}

(async function() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select('body').append('svg').attr('viewBox', [0, 0, width, height]);
    const tooltip = d3.select(".tooltip");
    
    // Projection
    const projection = d3.geoAlbersUsa().fitWidth(width, {type: "Sphere"});
    const path = d3.geoPath().projection(projection);
    const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", e => g.attr("transform", e.transform));
    const g = svg.append("g");

    try {
        // 1. Load Topology & Live Data
        const [us, rawData] = await Promise.all([
            d3.json(ATLAS_URL),
            d3.csv(JHU_URL)
        ]);

        document.getElementById("loading-msg").textContent = "‚úÖ Data Loaded Successfully";
        
        // Debug: Log the first row to confirm column names
        console.log("First row of data:", rawData[0]);

        // 2. Process Data
        // Based on screenshot, columns are likely 'location_id' and 'value' (or 'cases')
        const grouped = d3.rollup(rawData, 
            v => d3.sum(v, d => {
                // Heuristic: Try to find the "count" column
                const val = d.value || d.cases || d.count || 0; 
                return +val;
            }), 
            d => {
                // Ensure FIPS is 5 digits (e.g., 8001 -> 08001)
                const fips = d.location_id || d.fips || "";
                return fips.toString().padStart(5, "0");
            }
        );

        // Update Stats
        const totalCases = d3.sum(rawData, d => +(d.value || d.cases || 0));
        document.getElementById("data-stats").innerText = `Tracking ${totalCases} reported cases`;

        const states = topojson.feature(us, us.objects.states).features;
        const counties = topojson.feature(us, us.objects.counties).features;

        // Color Scale
        const color = d3.scaleThreshold()
            .domain([1, 5, 10, 25, 50])
            .range(["#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#cb181d"]);

        // 3. Draw Map
        
        // State Layer
        g.selectAll(".state")
            .data(states)
            .join("path")
            .attr("class", "state")
            .attr("d", path)
            .on("click", clicked);

        // State Boundaries
        g.append("path")
            .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
            .attr("fill", "none")
            .attr("stroke", "white")
            .attr("stroke-width", 1.5)
            .attr("d", path);

        svg.call(zoom);

        // --- INTERACTION LOGIC ---

        function clicked(event, d) {
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            event.stopPropagation();
            
            const w = x1 - x0, h = y1 - y0;
            const k = Math.min(8, 0.9 / Math.max(w / width, h / height));
            const tx = width / 2 - (x0 + x1) / 2 * k;
            const ty = height / 2 - (y0 + y1) / 2 * k;

            svg.transition().duration(750).call(
                zoom.transform, 
                d3.zoomIdentity.translate(tx, ty).scale(k)
            );

            renderCounties(d);
        }

        function renderCounties(stateFeature) {
            g.selectAll(".county").remove();
            
            // Filter counties by State FIPS prefix
            const stateFips = stateFeature.id;
            const stateCounties = counties.filter(c => c.id.startsWith(stateFips));

            g.insert("g", ".state") // Insert below states so borders sit on top? Or above?
                .selectAll("path")
                .data(stateCounties)
                .join("path")
                .attr("class", "county")
                .attr("d", path)
                .attr("fill", d => {
                    const val = grouped.get(d.id);
                    return val ? color(val) : "#fff"; 
                })
                .on("mouseover", (event, d) => {
                    const val = grouped.get(d.id) || 0;
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.properties.name}</strong><br>Cases: ${val}`)
                        .style("left", event.pageX + "px")
                        .style("top", event.pageY + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));
                
            // Fade out state to reveal counties
            g.selectAll(".state").transition().style("opacity", 0.1);
        }

        svg.on("click", () => {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            g.selectAll(".county").remove();
            g.selectAll(".state").transition().style("opacity", 1);
        });

    } catch (e) {
        reportError(e.message);
    }
})();
</script>
</body>
</html>
