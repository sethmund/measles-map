<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Measles Tracker (Dark Mode)</title>
    <style>
        /* FORCE DARK MODE */
        html, body { 
            background-color: #000000 !important; /* Pure Black */
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }

        /* INFO BOX - Moved to Bottom Right */
        #status {
            position: absolute; 
            bottom: 30px; 
            right: 30px;
            background: rgba(20, 20, 20, 0.9); /* Dark semi-transparent */
            border: 1px solid #444;
            color: #eee;
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            min-width: 200px;
        }

        h2 { margin: 0 0 10px 0; font-size: 18px; color: #ff4444; letter-spacing: 1px; }
        .stat-line { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .highlight { color: #fff; font-weight: bold; }

        /* SVG MAP */
        svg { display: block; width: 100%; height: 100%; }

        /* PATH STYLES */
        .state { 
            stroke: #333; 
            stroke-width: 1; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .state:hover { 
            stroke: #fff; 
            stroke-width: 2; 
            filter: brightness(1.2);
        }

        .county { 
            stroke: rgba(0,0,0,0.5); 
            stroke-width: 0.5; 
            pointer-events: all; 
        }

        /* TOOLTIP */
        .tooltip {
            position: absolute; 
            background: rgba(0, 0, 0, 0.95); 
            color: #fff; 
            padding: 10px 15px; 
            border: 1px solid #555;
            border-radius: 4px; 
            pointer-events: none; 
            opacity: 0; 
            font-size: 14px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transform: translate(-50%, -100%); 
            margin-top: -15px;
            white-space: nowrap; 
            z-index: 1000;
        }
    </style>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>
<body>

<div id="status">
    <h2>MEASLES TRACKER</h2>
    <div class="stat-line" id="loading-msg">⏳ Fetching live data...</div>
    <div class="stat-line" id="data-stats"></div>
    <div style="margin-top:10px; font-size:11px; color:#555;">
        Source: JHU CSSE Data<br>
        Click a state to zoom.
    </div>
</div>

<div class="tooltip"></div>

<script>
// --- CONFIGURATION ---
const JHU_URL = "https://raw.githubusercontent.com/CSSEGISandData/measles_data/main/measles_county_all_updates.csv";
const ATLAS_URL = "https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json";

(async function() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select('body').append('svg').attr('viewBox', [0, 0, width, height]);
    const tooltip = d3.select(".tooltip");
    
    // Projection
    const projection = d3.geoAlbersUsa().fitWidth(width, {type: "Sphere"});
    const path = d3.geoPath().projection(projection);
    const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", e => g.attr("transform", e.transform));
    const g = svg.append("g");

    try {
        // 1. Load Data
        const [us, rawData] = await Promise.all([
            d3.json(ATLAS_URL),
            d3.csv(JHU_URL)
        ]);

        document.getElementById("loading-msg").innerHTML = "<span style='color:#4caf50'>● Live System Active</span>";

        // 2. Process Data (County Level)
        const countyData = new Map();
        
        rawData.forEach(d => {
            const val = +d.value || +d.cases || 0;
            // FORCE 5-digit string for County FIPS (e.g. 8001 -> "08001")
            let fips = (d.location_id || d.fips || "").toString();
            if (fips.length > 0 && fips.length < 5) fips = fips.padStart(5, "0");
            
            if (countyData.has(fips)) {
                countyData.set(fips, countyData.get(fips) + val);
            } else {
                countyData.set(fips, val);
            }
        });

        // 3. Aggregate Data (State Level)
        const states = topojson.feature(us, us.objects.states).features;
        const counties = topojson.feature(us, us.objects.counties).features;

        let totalCases = 0;

        states.forEach(state => {
            // FORCE 2-digit string for State FIPS (e.g. 6 -> "06")
            const stateFips = state.id.toString().padStart(2, "0");
            
            // Find counties that start with this State FIPS
            const stateCounties = counties.filter(c => {
                const cFips = c.id.toString().padStart(5, "0");
                return cFips.startsWith(stateFips);
            });
            
            // Sum cases
            const stateTotal = d3.sum(stateCounties, c => {
                const cFips = c.id.toString().padStart(5, "0");
                return countyData.get(cFips) || 0;
            });

            state.properties.cases = stateTotal;
            totalCases += stateTotal;
        });

        document.getElementById("data-stats").innerHTML = `Total Reported: <span class="highlight">${totalCases.toLocaleString()}</span>`;

        // 4. Color Scale (Dark Mode Neon)
        const color = d3.scaleThreshold()
            .domain([1, 5, 20, 50, 100])
            .range(["#1a1a1a", "#4a0404", "#8a0808", "#c40c0c", "#ff1111", "#ff5555"]);
            // #1a1a1a = Dark Gray (0 cases)

        // 5. Draw Map
        
        // Draw States (Choropleth)
        const stateLayer = g.selectAll(".state")
            .data(states)
            .join("path")
            .attr("class", "state")
            .attr("d", path)
            .attr("fill", d => {
                return d.properties.cases > 0 ? color(d.properties.cases) : "#1a1a1a";
            })
            .on("click", clicked)
            .on("mouseover", (event, d) => showTooltip(event, d.properties.name, d.properties.cases, "State Total"))
            .on("mouseout", hideTooltip);

        // Draw State Boundaries (Thin Light Lines)
        g.append("path")
            .datum(topojson.mesh(us, us.objects.states, (a, b) => a !== b))
            .attr("fill", "none")
            .attr("stroke", "#444")
            .attr("stroke-width", 0.8)
            .attr("d", path)
            .style("pointer-events", "none");

        svg.call(zoom);

        // --- INTERACTION LOGIC ---

        function clicked(event, d) {
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            event.stopPropagation();
            
            // Calculate Zoom
            const w = x1 - x0, h = y1 - y0;
            const k = Math.min(8, 0.9 / Math.max(w / width, h / height));
            const tx = width / 2 - (x0 + x1) / 2 * k;
            const ty = height / 2 - (y0 + y1) / 2 * k;

            svg.transition().duration(750).call(
                zoom.transform, 
                d3.zoomIdentity.translate(tx, ty).scale(k)
            );

            renderCounties(d);
        }

        function renderCounties(stateFeature) {
            g.selectAll(".county").remove();
            
            const stateFips = stateFeature.id.toString().padStart(2, "0");
            const stateCounties = counties.filter(c => c.id.toString().padStart(5, "0").startsWith(stateFips));

            g.append("g") 
                .selectAll("path")
                .data(stateCounties)
                .join("path")
                .attr("class", "county")
                .attr("d", path)
                .attr("fill", d => {
                    const cFips = d.id.toString().padStart(5, "0");
                    const val = countyData.get(cFips) || 0;
                    return val > 0 ? color(val) : "#1a1a1a";
                })
                .on("mouseover", (event, d) => {
                    const cFips = d.id.toString().padStart(5, "0");
                    showTooltip(event, d.properties.name, countyData.get(cFips), "County Cases");
                })
                .on("mouseout", hideTooltip)
                .style("opacity", 0)
                .transition().duration(500)
                .style("opacity", 1);
        }

        function showTooltip(event, name, val, label) {
            val = val || 0;
            tooltip.style("opacity", 1)
                .html(`<strong>${name}</strong><br><span style='color:#aaa'>${label}</span>: <span style='color:#ff5555; font-weight:bold'>${val}</span>`)
                .style("left", event.pageX + "px")
                .style("top", event.pageY + "px");
        }

        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        svg.on("click", () => {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            g.selectAll(".county").transition().style("opacity", 0).remove();
            g.selectAll(".state").transition().style("opacity", 1);
        });

    } catch (e) {
        console.error(e);
        document.getElementById("loading-msg").textContent = "❌ Error: " + e.message;
    }
})();
</script>
</body>
</html>
