<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JHU Measles Map (Debug Mode)</title>
    <style>
        body { 
            background: #f4f4f9; 
            font-family: sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden;
        }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #555;
            text-align: center;
        }

        #error-box {
            display: none;
            background: #ffe6e6;
            color: #d8000c;
            border: 1px solid #d8000c;
            padding: 20px;
            border-radius: 5px;
            max-width: 80%;
            z-index: 999;
        }

        svg {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        path { stroke: #fff; stroke-width: 0.5; }
        .state { fill: #ccc; cursor: pointer; }
        .state:hover { fill: #bbb; }
        .county { stroke: #fff; stroke-width: 0.2; }
        
        .tooltip {
            position: absolute; 
            background: rgba(0,0,0,0.8); 
            color: #fff; 
            padding: 8px; 
            border-radius: 4px; 
            pointer-events: none; 
            opacity: 0; 
            font-size: 14px;
        }
    </style>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
</head>
<body>

<div id="status">‚è≥ Loading Map Data...<br><span style="font-size:16px">(This may take a few seconds)</span></div>
<div id="error-box"></div>
<div class="tooltip"></div>

<script>
// --- ERROR HANDLER ---
function reportError(msg) {
    const box = document.getElementById("error-box");
    const status = document.getElementById("status");
    status.style.display = "none";
    box.style.display = "block";
    box.innerHTML = `<strong>Error:</strong> ${msg}<br><br>Check the Console (F12) for details.`;
    console.error(msg);
}

// --- MAIN SCRIPT ---
(async function() {
    try {
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select('body')
            .append('svg')
            .attr('viewBox', [0, 0, width, height]);

        const tooltip = d3.select(".tooltip");
        const projection = d3.geoAlbersUsa().fitWidth(width, {type: "Sphere"});
        const path = d3.geoPath().projection(projection);

        // URLs
        const JHU_URL = "https://raw.githubusercontent.com/CSSEGISandData/measles_data/main/measles_daily_cases_by_county.csv";
        const ATLAS_URL = "https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json";

        // Load Data
        console.log("Fetching data...");
        const [us, rawData] = await Promise.all([
            d3.json(ATLAS_URL),
            d3.csv(JHU_URL)
        ]);

        console.log("Data loaded. Processing...");
        document.getElementById("status").textContent = "Processing Data...";

        // Process Data
        const grouped = d3.rollup(rawData, 
            v => d3.sum(v, d => +d.value), 
            d => d.location_id.padStart(5, "0")
        );

        const states = topojson.feature(us, us.objects.states).features;
        const counties = topojson.feature(us, us.objects.counties).features;

        // Color Scale
        const color = d3.scaleThreshold()
            .domain([1, 5, 10, 20, 50])
            .range(["#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26", "#a50f15"]);

        // Draw Map
        document.getElementById("status").style.display = "none"; // Hide loader

        // Draw States
        const stateLayer = svg.append("g").selectAll("path")
            .data(states)
            .join("path")
            .attr("class", "state")
            .attr("d", path)
            .on("click", clicked);

        // Zoom Function
        function clicked(event, d) {
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            const w = x1 - x0;
            const h = y1 - y0;
            const x = (x0 + x1) / 2;
            const y = (y0 + y1) / 2;
            const k = Math.min(8, 0.9 / Math.max(w / width, h / height));
            const translate = [width / 2 - x * k, height / 2 - y * k];

            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(k)
            );
            
            // Render counties on zoom (optimization)
            renderCounties(d);
        }

        const zoom = d3.zoom().on("zoom", (event) => {
            svg.selectAll("g").attr("transform", event.transform);
        });

        function renderCounties(stateFeature) {
            // Remove old counties
            svg.selectAll(".county").remove();

            // Find counties for this state
            const stateCounties = counties.filter(c => c.id.startsWith(stateFeature.id));

            svg.append("g")
                .selectAll("path")
                .data(stateCounties)
                .join("path")
                .attr("class", "county")
                .attr("d", path)
                .attr("fill", d => {
                    const val = grouped.get(d.id) || 0;
                    return val > 0 ? color(val) : "#fff";
                })
                .on("mouseover", (event, d) => {
                    const val = grouped.get(d.id) || 0;
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.properties.name}</strong><br>Cases: ${val}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));
        }

    } catch (error) {
        reportError(error.message);
    }
})();
</script>
</body>
</html>
